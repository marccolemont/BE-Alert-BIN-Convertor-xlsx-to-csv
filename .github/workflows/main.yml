name: Build BIN-Convertor (Win + macOS + Pi64) – Signed Version

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-x64
            runner: windows-latest
            kind: windows
            target: x86_64-pc-windows-msvc

          - name: macos-app
            runner: macos-latest
            kind: macos

          - name: raspberrypi-64
            runner: ubuntu-latest
            kind: pi
            target: aarch64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # ================= WINDOWS =================
      - name: Build (Windows x64)
        if: matrix.kind == 'windows'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload (Windows exe)
        if: matrix.kind == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: BIN-Convertor-windows-x64
          path: target/${{ matrix.target }}/release/*.exe

      # ================= macOS =================
      - name: Install cargo-bundle
        if: matrix.kind == 'macos'
        run: cargo install cargo-bundle

      - name: Bundle (macOS)
        if: matrix.kind == 'macos'
        run: cargo bundle --release

      - name: Import Developer ID certificate
        if: matrix.kind == 'macos'
        env:
          CERT_B64: ${{ secrets.MACOS_CERT_P12_B64 }}
          CERT_PASSWORD: ${{ secrets.MACOS_CERT_P12_PASSWORD }}
        run: |
          python3 - <<'PY'
          import os, base64, re, hashlib
          b64 = os.environ.get('CERT_B64','')
          b64 = re.sub(r"\s+", "", b64)
          print(f"CERT_B64 length (chars): {len(b64)}")
          data = base64.b64decode(b64)
          with open('developerid.p12','wb') as f:
              f.write(data)
          print(f"Wrote developerid.p12 ({len(data)} bytes)")
          print(f"developerid.p12 sha256: {hashlib.sha256(data).hexdigest()}")
          PY

          # Show what kind of file this is (helps detect if it's actually a .cer/.der)
          file developerid.p12 || true

          # Quick sanity check to fail fast with a helpful error if the secret isn't a real .p12
          openssl pkcs12 -in developerid.p12 -passin pass:"$CERT_PASSWORD" -noout

      - name: Codesign macOS app (Developer ID)
        if: matrix.kind == 'macos'
        env:
          SIGN_ID: ${{ secrets.DEVELOPERID_APPLE }}
        run: |
          APP=$(ls -d target/release/bundle/osx/*.app)
          codesign --force --deep --options runtime --timestamp --sign "$SIGN_ID" "$APP"
          codesign --verify --deep --strict --verbose=2 "$APP"

      - name: Notarize and staple macOS app
        if: matrix.kind == 'macos'
        env:
          KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          KEY_P8_B64: ${{ secrets.APPLE_API_KEY_P8_B64 }}
        run: |
          echo "$KEY_P8_B64" | base64 --decode > AuthKey.p8
          mkdir -p "$HOME/private_keys"
          cp AuthKey.p8 "$HOME/private_keys/AuthKey_${KEY_ID}.p8"

          APP=$(ls -d target/release/bundle/osx/*.app)
          ditto -c -k --sequesterRsrc --keepParent "$APP" app.zip

          xcrun notarytool submit app.zip \
            --key "$HOME/private_keys/AuthKey_${KEY_ID}.p8" \
            --key-id "$KEY_ID" \
            --issuer "$ISSUER_ID" \
            --wait

          xcrun stapler staple "$APP"

      - name: Upload (macOS app – signed)
        if: matrix.kind == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: BIN-Convertor-macos-app
          path: target/release/bundle/osx/*.app

      # ================= PI =================
      - name: Setup QEMU (for cross)
        if: matrix.kind == 'pi'
        uses: docker/setup-qemu-action@v3

      - name: Install cross
        if: matrix.kind == 'pi'
        run: cargo install cross --locked

      - name: Build (Raspberry Pi 64-bit)
        if: matrix.kind == 'pi'
        run: cross build --release --target ${{ matrix.target }}

      - name: Upload (Pi 64 binary)
        if: matrix.kind == 'pi'
        uses: actions/upload-artifact@v4
        with:
          name: BIN-Convertor-raspberrypi-64
          path: target/${{ matrix.target }}/release/*